<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç‰©ç†ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿé¨“ãƒ¬ãƒãƒ¼ãƒˆ</title>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" crossorigin="anonymous">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js" crossorigin="anonymous"></script>
    <script defer
      src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"
      crossorigin="anonymous"
      onload="initKatex()"></script>

    <script>
        function initKatex() {
            try {
                renderMathInElement(document.body, {
                    delimiters: [
                        {left: '$$', right: '$$', display: true},
                        {left: '$', right: '$', display: false},
                        {left: '\\(', right: '\\)', display: false},
                        {left: '\\[', right: '\\]', display: true}
                    ],
                    throwOnError: false
                });
            } catch (e) {
                console.error('KaTeX auto-render failed:', e);
            }
        }
    </script>

    <style>
        body {
            font-family: "Hiragino Kaku Gothic ProN", "Meiryo", sans-serif;
            background-color: #f0f2f5;
            color: #333;
            margin: 0;
            padding: 20px;
            line-height: 1.6;
        }
        .container {
            max-width: 210mm; /* A4å¹… */
            margin: 0 auto;
            background-color: #fff;
            padding: 20mm;
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
            box-sizing: border-box;
            position: relative;
        }
        
        /* PDFå‡ºåŠ›æ™‚ã®æ”¹ãƒšãƒ¼ã‚¸åˆ¶å¾¡ç”¨ã‚¯ãƒ©ã‚¹ */
        .no-break {
            page-break-inside: avoid;
            break-inside: avoid;
        }

        /* ãƒ˜ãƒƒãƒ€ãƒ¼æƒ…å ± */
        .header-info {
            display: flex;
            justify-content: space-between;
            border-bottom: 2px solid #000;
            padding-bottom: 10px;
            margin-bottom: 30px;
        }
        .input-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        input[type="text"] {
            border: none;
            border-bottom: 1px solid #ccc;
            font-size: 16px;
            padding: 5px;
            width: 150px;
            background: #fafafa;
        }
        
        h1 {
            text-align: center;
            font-size: 24px;
            margin-bottom: 20px;
        }
        h2 {
            background-color: #e3f2fd;
            padding: 10px;
            border-left: 6px solid #2196f3;
            font-size: 18px;
            margin-top: 30px;
            margin-bottom: 15px;
            page-break-after: avoid;
        }
        h3 {
            font-size: 16px;
            margin-top: 15px;
            color: #444;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
            page-break-after: avoid;
        }
        
        .cycle-guide {
            background-color: #fff8e1;
            border: 1px dashed #ffc107;
            padding: 10px;
            font-size: 12px;
            margin-bottom: 20px;
            color: #666;
        }

        .content-box {
            margin-bottom: 20px;
        }
        
        .question-text {
            font-weight: bold;
            color: #d32f2f;
            background: #fff5f5;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        .procedure-text {
            background: #f1f8e9;
            padding: 10px;
            font-size: 14px;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        
        textarea {
            width: 100%;
            min-height: 80px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: inherit;
            font-size: 14px;
            resize: vertical;
            box-sizing: border-box;
            line-height: 1.6;
        }

        /* å°åˆ·/PDFç”Ÿæˆæ™‚ã®ä¸€æ™‚ç½®æ›ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
        .print-replacement {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-family: inherit;
            font-size: 14px;
            line-height: 1.6;
            white-space: pre-wrap; /* æ”¹è¡Œã‚’ç¶­æŒ */
            word-wrap: break-word; /* é•·ã„å˜èªã‚’æŠ˜ã‚Šè¿”ã™ */
            overflow-wrap: break-word;
            background-color: #fff;
            min-height: 40px;
            color: #000;
        }
        
        .btn-sim {
            display: inline-block;
            background-color: #2196f3;
            color: white;
            padding: 8px 16px;
            text-decoration: none;
            border-radius: 4px;
            font-size: 14px;
            margin: 5px 0;
            transition: background 0.3s;
        }
        .btn-sim:hover { background-color: #1976d2; }
        
        .action-area {
            text-align: center;
            margin-top: 40px;
            margin-bottom: 60px;
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
        }
        .btn-action {
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 16px;
            border-radius: 5px;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: opacity 0.3s;
        }
        .btn-pdf { background-color: #4caf50; }
        .btn-pdf:hover { background-color: #388e3c; }
        .btn-png { background-color: #ff9800; }
        .btn-png:hover { background-color: #f57c00; }

        .circuit-image-container {
            text-align: center;
            margin: 20px 0;
            padding: 10px;
            border: 1px solid #eee;
            background-color: #fafafa;
            min-height: 100px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .circuit-image-container img {
            max-width: 100%;
            max-height: 300px;
            height: auto;
            border: 1px solid #ccc;
        }
        .img-caption {
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 5px;
            color: #555;
        }
        
        /* ç”»åƒèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼æ™‚ã®ä»£æ›¿è¡¨ç¤º */
        .img-placeholder {
            padding: 20px;
            background: #eee;
            color: #666;
            border: 2px dashed #999;
            font-size: 12px;
            width: 80%;
        }

        #loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            font-size: 18px;
            color: #333;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        @media print {
            .no-print { display: none !important; }
            body { background: white; padding: 0; }
            .container { box-shadow: none; padding: 0; max-width: 100%; width: 100%; }
            textarea { display: none; }
            .print-replacement { display: block; }
        }
    </style>
</head>
<body>

<div id="loading-overlay">
    <div class="spinner"></div>
    <div id="loading-text">å‡¦ç†ä¸­...</div>
</div>

<div class="container" id="report-content">
    <h1>ç‰©ç†ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿé¨“ãƒ¬ãƒãƒ¼ãƒˆ</h1>
    
    <div class="header-info no-break">
        <div class="input-group">
            <label>ã‚¯ãƒ©ã‚¹:</label>
            <input type="text" placeholder="ä¾‹: 2-A">
        </div>
        <div class="input-group">
            <label>ç•ªå·:</label>
            <input type="text" placeholder="ä¾‹: 15">
        </div>
        <div class="input-group">
            <label>åå‰:</label>
            <input type="text" placeholder="æ°åã‚’å…¥åŠ›">
        </div>
    </div>

    <div class="cycle-guide no-break">
        <strong>ã€å•ã„ã®ã‚µã‚¤ã‚¯ãƒ«ã€‘ã«ã¤ã„ã¦</strong><br>
        ã€Œ1.å•ã„ã€â†’ã€Œ2.è‡ªåˆ†ã®è€ƒãˆãƒ»ä»®èª¬ã€â†’ã€Œ3.èª¿ã¹ãŸã“ã¨ï¼ˆå®Ÿé¨“ï¼‰ã€â†’ã€Œ4.æ°—ã¥ã„ãŸã“ã¨ã€ã‚’1ã‚µã‚¤ã‚¯ãƒ«ã¨ã—ã¾ã™ã€‚<br>
        ã“ã®ã‚µã‚¤ã‚¯ãƒ«ã‚’ç¹°ã‚Šè¿”ã—ã€å¾—ã‚‰ã‚ŒãŸã€Œæ°—ã¥ã„ãŸã“ã¨ã€ã‚’çµ±åˆã—ã¦è€ƒå¯Ÿã—ãŸã‚‚ã®ã‚’ã€Œ5.ã‚ã‹ã£ãŸã“ã¨ï¼ˆå­¦å•ï¼‰ã€ã¨ã—ã¦è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚
    </div>

    <div class="no-break">
        <h2>1. ã‚³ãƒ³ãƒ‡ãƒ³ã‚µãƒ¼ã®å¾®è¦–çš„ç†è§£ã¨ã‚¨ãƒãƒ«ã‚®ãƒ¼ï¼ˆå•é¡Œ [I] å¯¾å¿œï¼‰</h2>
        <a href="https://takeruhonda.github.io/physics-electromagnetism-sim/Electron_micro_physics_2025_17.html" target="_blank" class="btn-sim no-print">
            ğŸ“¡ ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ã‚’é–‹ã (Micro Physics)
        </a>
    </div>

    <div class="content-box no-break">
        <h3>1. å•ã„ï¼ˆæ¡ä»¶æ¯”è¼ƒï¼‰</h3>
        <div class="question-text">
            å•é¡Œ[I]ã§ã¯ã€Œã‚¹ã‚¤ãƒƒãƒã‚’åˆ‡ã£ãŸï¼ˆ$Q$ä¸€å®šï¼‰ã€çŠ¶æ…‹ã§æ¥µæ¿é–“éš” $d$ ã‚’åºƒã’ãŸãŒã€ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ã®ã‚ˆã†ã«<strong>ã€Œé›»æ± ã‚’ã¤ãªã„ã ã¾ã¾ï¼ˆ$V$ä¸€å®šï¼‰ã€</strong>ã§ $d$ ã‚’åºƒã’ã‚‹ã¨ã€é™é›»ã‚¨ãƒãƒ«ã‚®ãƒ¼ $U$ ã¨é›»å ´ $E$ ã¯ã©ã®ã‚ˆã†ã«å¤‰åŒ–ã™ã‚‹ã‹ï¼Ÿ ã¾ãŸã€ãªãœå•é¡Œ[I]ã®çµæœã¨ç•°ãªã‚‹ã®ã‹ï¼Ÿ
        </div>
    </div>

    <div class="content-box no-break">
        <h3>2. è‡ªåˆ†ã®è€ƒãˆãƒ»ä»®èª¬</h3>
        <textarea placeholder="é›»æ± ãŒã¤ãªãŒã£ã¦ã„ã‚‹ã¨é›»åœ§ $V$ ã¯... ãªã®ã§ã€æ¥µæ¿ã‚’åºƒã’ã‚‹ã¨ã‚¨ãƒãƒ«ã‚®ãƒ¼ã¯... ã™ã‚‹ã¨äºˆæƒ³ã™ã‚‹ã€‚å•é¡Œ[I]ã®çµæœï¼ˆã‚¨ãƒãƒ«ã‚®ãƒ¼å¢—åŠ ï¼‰ã¨æ¯”è¼ƒã™ã‚‹ã¨..."></textarea>
    </div>

    <div class="content-box no-break">
        <h3>3. èª¿ã¹ãŸã“ã¨ï¼ˆå®Ÿé¨“æ‰‹é †ï¼‰</h3>
        <div class="procedure-text">
            <ol>
                <li>ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ã®ã€Œã‚³ãƒ³ãƒ‡ãƒ³ã‚µãƒ¼ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’é–‹ãã€‚</li>
                <li>ã€Œå°åŠ é›»åœ§ Vã€ã‚’é©å½“ãªå€¤ï¼ˆä¾‹: 5Vï¼‰ã«è¨­å®šã™ã‚‹ã€‚<strong>ï¼ˆâ€»ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ã¯å¸¸ã«é›»æ± æ¥ç¶šçŠ¶æ…‹ã§ã™ï¼‰</strong></li>
                <li>ã€Œæ¥µæ¿é–“è·é›¢ dã€ã‚’æœ€å°ï¼ˆ1.0mmï¼‰ã«ã—ã€ãã®æ™‚ã®ã‚¨ãƒãƒ«ã‚®ãƒ¼ $U$ ã¨é›»å ´ $E$ ã®å€¤ã‚’è¨˜éŒ²ã™ã‚‹ã€‚</li>
                <li>ã€Œæ¥µæ¿é–“è·é›¢ dã€ã‚’åºƒã’ï¼ˆä¾‹: 2.0mmï¼‰ã€$U$ ã¨ $E$ ãŒå¢—ãˆã‚‹ã‹æ¸›ã‚‹ã‹ã‚’ç¢ºèªã™ã‚‹ã€‚</li>
            </ol>
        </div>
        <h3>å®Ÿé¨“çµæœ</h3>
        <textarea placeholder="dã‚’1.0mmã‹ã‚‰2.0mmã«åºƒã’ã‚‹ã¨ã€ã‚¨ãƒãƒ«ã‚®ãƒ¼ U ã¯... é›»å ´ E ã¯... ã«å¤‰åŒ–ã—ãŸã€‚"></textarea>
    </div>

    <div class="content-box no-break">
        <h3>4. æ°—ã¥ã„ãŸã“ã¨ï¼ˆä»®èª¬ã¨ã®å¯¾æ¯”ï¼‰</h3>
        <textarea placeholder="å•é¡Œ[I]ï¼ˆã‚¹ã‚¤ãƒƒãƒOFFï¼‰ã®è¨ˆç®—ã§ã¯ã‚¨ãƒãƒ«ã‚®ãƒ¼ã¯å¢—ãˆãŸãŒã€å®Ÿé¨“ï¼ˆã‚¹ã‚¤ãƒƒãƒONï¼‰ã§ã¯... ã ã£ãŸã€‚ã“ã®é•ã„ã¯é›»æ± ãŒ... ã ã‹ã‚‰ã ã¨æ°—ã¥ã„ãŸã€‚"></textarea>
    </div>

    <div class="no-break">
        <h2>2. è¤‡é›‘ãªå›è·¯ã®å®šå¸¸çŠ¶æ…‹ã¨é›»ä½ã®ãƒãƒ©ãƒ³ã‚¹ï¼ˆå•é¡Œ [II] å¯¾å¿œï¼‰</h2>
        <a href="https://takeruhonda.github.io/physics-electromagnetism-sim/Electron_circuit_physics_2025_7.html" target="_blank" class="btn-sim no-print">
            ğŸ”Œ ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ã‚’é–‹ã (Circuit Physics)
        </a>
    </div>

    <div class="content-box no-break">
        <div class="circuit-image-container">
            <div class="img-caption">å›³4ï¼šå®Ÿé¨“å¯¾è±¡ã®å›è·¯å›³</div>
            <img id="fig4" src="./figure4.png" alt="å›³4" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
            <div class="img-placeholder" style="display:none;">
                [ç”»åƒ: figure4.png ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ]<br>
                â€»åŒã˜ãƒ•ã‚©ãƒ«ãƒ€ã«ç”»åƒã‚’é…ç½®ã—ã¦ãã ã•ã„
            </div>
        </div>
    </div>

    <div class="content-box no-break">
        <h3>1. å•ã„</h3>
        <div class="question-text">
            å›³4ï¼ˆä¸Šå›³ï¼‰ã®ã‚ˆã†ãªå›è·¯ã«ãŠã„ã¦ã€ã‚¹ã‚¤ãƒƒãƒã‚’ã™ã¹ã¦é–‰ã˜ã¦æ™‚é–“ãŒçµŒã£ãŸå¾Œã€ä¸­å¤®ã®ã‚³ãƒ³ãƒ‡ãƒ³ã‚µãƒ¼ $C_3$ ã«é›»è·ãŒå…¨ãæºœã¾ã‚‰ãªããªã‚‹ï¼ˆé›»æµãŒæµã‚Œãªã„ï¼‰ã®ã¯ã€ä»–ã®æŠµæŠ—ã‚„ã‚³ãƒ³ãƒ‡ãƒ³ã‚µãƒ¼ãŒã©ã®ã‚ˆã†ãªé–¢ä¿‚ã®æ™‚ã‹ï¼Ÿ
        </div>
    </div>

    <div class="content-box no-break">
        <h3>2. è‡ªåˆ†ã®è€ƒãˆãƒ»ä»®èª¬</h3>
        <textarea placeholder="ä¸­å¤®ã«é›»æ°—ãŒæµã‚Œãªã„ã¨ã„ã†ã“ã¨ã¯ã€ä¸Šä¸‹ã®é›»ä½ãŒ... ã«ãªã£ã¦ã„ã‚‹ã¯ãšã€‚ãã®ãŸã‚ã«ã¯æŠµæŠ—å€¤ã¨å®¹é‡ãŒ... ã¨ã„ã†é–¢ä¿‚ãŒå¿…è¦ã ã¨æ€ã†ã€‚"></textarea>
    </div>

    <div class="content-box no-break">
        <h3>3. èª¿ã¹ãŸã“ã¨ï¼ˆå®Ÿé¨“æ‰‹é †ï¼‰</h3>
        <div class="procedure-text">
            <ol>
                <li>å›³4ã¨åŒã˜å›è·¯ï¼ˆæŠµæŠ—2ã¤ã€ã‚³ãƒ³ãƒ‡ãƒ³ã‚µãƒ¼3ã¤ã€ã‚¹ã‚¤ãƒƒãƒ2ã¤ï¼‰ã‚’ä½œæˆã™ã‚‹ã€‚</li>
                <li>å…¨ã¦ã®ã‚¹ã‚¤ãƒƒãƒã‚’é–‰ã˜ã€å®šå¸¸çŠ¶æ…‹ï¼ˆé›»æµãŒä¸€å®šï¼‰ã«ãªã‚‹ã¾ã§å¾…ã¤ã€‚</li>
                <li>æŠµæŠ— $R_1, R_2$ ã‚„å®¹é‡ $C_1, C_2$ ã®å€¤ã‚’ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã§å¤‰åŒ–ã•ã›ã‚‹ã€‚</li>
                <li>ä¸­å¤®ã®ã‚³ãƒ³ãƒ‡ãƒ³ã‚µãƒ¼ $C_3$ ã®é›»è·ï¼ˆã¾ãŸã¯é›»åœ§ï¼‰ãŒã¡ã‚‡ã†ã© <strong>0</strong> ã«ãªã‚‹æ¡ä»¶ã‚’æ¢ã™ã€‚</li>
            </ol>
        </div>
        <h3>å®Ÿé¨“çµæœ</h3>
        <textarea placeholder="R1ã‚’...Î©, R2ã‚’...Î©, C1ã‚’...F, C2ã‚’...F ã«è¨­å®šã—ãŸæ™‚ã€C3ã®é›»è·ãŒ0ã«ãªã£ãŸã€‚è¨ˆç®—ã—ã¦ã¿ã‚‹ã¨..."></textarea>
    </div>

    <div class="content-box no-break">
        <h3>4. æ°—ã¥ã„ãŸã“ã¨ï¼ˆä»®èª¬ã¨ã®å¯¾æ¯”ï¼‰</h3>
        <textarea placeholder="é›»è·ãŒ0ã«ãªã‚‹æ¡ä»¶ã¯ã€æŠµæŠ—ã®æ¯”ã¨ã‚³ãƒ³ãƒ‡ãƒ³ã‚µãƒ¼ã®æ¯”ãŒ... ã«ãªã£ã¦ã„ã‚‹æ™‚ã ã£ãŸã€‚ã“ã‚Œã¯ãƒ›ã‚¤ãƒ¼ãƒˆã‚¹ãƒˆãƒ³ãƒ–ãƒªãƒƒã‚¸ã¨ä¼¼ã¦ã„ã¦..."></textarea>
    </div>

    <div class="content-box no-break">
        <h2>3. ã‚ã‹ã£ãŸã“ã¨ï¼ˆå­¦å•ï¼‰</h2>
        <p style="font-size:14px; color:#555;">â€»ä¸Šè¨˜ã®2ã¤ã®ã€Œæ°—ã¥ã„ãŸã“ã¨ã€ã‚’çµ±åˆã—ã€è€ƒå¯Ÿã—ã¦è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚</p>
        <textarea style="height: 150px;" placeholder="ä»Šå›ã®å®Ÿé¨“ã‚’é€šã—ã¦ã€ã‚³ãƒ³ãƒ‡ãƒ³ã‚µãƒ¼ã®æ¡ä»¶ï¼ˆæ¥ç¶š/åˆ‡æ–­ï¼‰ã«ã‚ˆã‚‹ã‚¨ãƒãƒ«ã‚®ãƒ¼å¤‰åŒ–ã®é•ã„ã‚„ã€å›è·¯ã®å¹³è¡¡æ¡ä»¶ã«ã¤ã„ã¦ä»¥ä¸‹ã®ã“ã¨ãŒã‚ã‹ã£ãŸã€‚..."></textarea>
    </div>
</div>

<div class="action-area no-print">
    <button class="btn-action btn-pdf" onclick="generateReport('pdf')">ğŸ“„ PDFã¨ã—ã¦ä¿å­˜</button>
    <button class="btn-action btn-png" onclick="generateReport('png')">ğŸ–¼ï¸ ç”»åƒã¨ã—ã¦ä¿å­˜</button>
</div>
<div style="text-align: center; font-size:12px; color:#666; margin-bottom:40px;" class="no-print">
    â€»ã€ŒPDFã¨ã—ã¦ä¿å­˜ã€ã§ã‚¨ãƒ©ãƒ¼ãŒå‡ºã‚‹å ´åˆã¯ã€Œç”»åƒã¨ã—ã¦ä¿å­˜ã€ã‚’è©¦ã—ã¦ãã ã•ã„ã€‚<br>
    â€»æ•°å¼ãŒè¡¨ç¤ºã•ã‚Œãªã„å ´åˆã¯ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚
</div>

<script>
    // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£: å‹•çš„ãªæ•°å¼ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
    function renderLatexInElement(element) {
        if (typeof renderMathInElement === 'function' && element) {
            try {
                renderMathInElement(element, {
                    delimiters: [
                        {left: '$$', right: '$$', display: true},
                        {left: '$', right: '$', display: false},
                        {left: '\\(', right: '\\)', display: false},
                        {left: '\\[', right: '\\]', display: true}
                    ],
                    throwOnError: false
                });
            } catch (error) {
                console.error("Dynamic KaTeX rendering error:", error);
            }
        }
    }

    // å…¥åŠ›æ¬„ã‚’ãƒ†ã‚­ã‚¹ãƒˆã«å¤‰æ›
    function replaceInputsWithText() {
        const textareas = document.querySelectorAll('textarea');
        const inputs = document.querySelectorAll('input[type="text"]');
        const replacements = [];

        textareas.forEach(textarea => {
            const div = document.createElement('div');
            div.className = 'print-replacement';
            // ç©ºã®å ´åˆã¯é«˜ã•ç¢ºä¿ç”¨ã®ã‚¹ãƒšãƒ¼ã‚¹ã‚’å…¥ã‚Œã‚‹
            div.innerText = textarea.value.trim() === "" ? "\n" : textarea.value;
            
            textarea.style.display = 'none';
            textarea.parentNode.insertBefore(div, textarea);
            replacements.push({ original: textarea, temp: div });
        });

        inputs.forEach(input => {
            const span = document.createElement('span');
            span.innerText = input.value;
            span.style.borderBottom = "1px solid #333";
            span.style.padding = "0 5px";
            span.style.display = "inline-block";
            span.style.minWidth = "100px";
            span.style.fontWeight = "bold";

            input.style.display = 'none';
            input.parentNode.insertBefore(span, input);
            replacements.push({ original: input, temp: span });
        });

        return replacements;
    }

    function restoreInputs(replacements) {
        replacements.forEach(item => {
            item.temp.remove();
            item.original.style.display = '';
        });
    }

    // â˜…é‡è¦: ç”»åƒã®äº‹å‰ãƒã‚§ãƒƒã‚¯å‡¦ç†
    // èª­ã¿è¾¼ã‚ã¦ã„ãªã„ç”»åƒãŒã‚ã‚‹ã¨ html2canvas ãŒã‚¯ãƒ©ãƒƒã‚·ãƒ¥ã™ã‚‹ãŸã‚ã€
    // ç”Ÿæˆå‰ã«ãƒã‚§ãƒƒã‚¯ã—ã¦DOMã‹ã‚‰é™¤å¤–ã¾ãŸã¯ç½®æ›ã™ã‚‹
    function sanitizeImages() {
        const images = document.querySelectorAll('img');
        images.forEach(img => {
            // naturalWidthãŒ0ã®å ´åˆã¯èª­ã¿è¾¼ã¿å¤±æ•—ã¨ã¿ãªã™
            if (img.naturalWidth === 0 || !img.complete) {
                console.warn('Image not loaded, hiding:', img.src);
                img.style.display = 'none';
                // ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ãŒã‚ã‚Œã°è¡¨ç¤º
                const nextEl = img.nextElementSibling;
                if (nextEl && nextEl.classList.contains('img-placeholder')) {
                    nextEl.style.display = 'block';
                }
                // html2canvasã«ç©ºã®srcã‚’æ¸¡ã•ãªã„ã‚ˆã†srcå±æ€§è‡ªä½“ã‚’ä¸€æ™‚é€€é¿
                img.setAttribute('data-broken-src', img.src);
                img.removeAttribute('src');
            }
        });
    }

    function restoreImages() {
        const images = document.querySelectorAll('img[data-broken-src]');
        images.forEach(img => {
            img.src = img.getAttribute('data-broken-src');
            img.removeAttribute('data-broken-src');
            // è¡¨ç¤ºçŠ¶æ…‹ã¯æˆ»ã•ãªã„ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ‰‹å‹•ã§ç›´ã™ã¾ã§ãã®ã¾ã¾ï¼‰
        });
    }

    async function generateReport(type) {
        const loading = document.getElementById('loading-overlay');
        const loadingText = document.getElementById('loading-text');
        
        loading.style.display = 'flex';
        loadingText.innerText = type === 'pdf' ? 'PDFã‚’ç”Ÿæˆä¸­...' : 'ç”»åƒã‚’ç”Ÿæˆä¸­...';

        // 1. ãƒ•ã‚©ãƒ³ãƒˆèª­ã¿è¾¼ã¿å¾…æ©Ÿ (é‡è¦)
        await document.fonts.ready;
        // 2. UIæç”»å¾…ã¡
        await new Promise(resolve => setTimeout(resolve, 500));

        const noPrintElements = document.querySelectorAll('.no-print');
        noPrintElements.forEach(el => el.style.display = 'none');

        const replacements = replaceInputsWithText();
        
        // 3. ç”»åƒã‚µãƒ‹ã‚¿ã‚¤ã‚º (é‡è¦: ã‚¨ãƒ©ãƒ¼å›é¿)
        sanitizeImages();

        const element = document.getElementById('report-content');

        try {
            if (type === 'pdf') {
                const opt = {
                    margin:       10, // mm
                    filename:     `ç‰©ç†ãƒ¬ãƒãƒ¼ãƒˆ_${new Date().toISOString().slice(0,10)}.pdf`,
                    image:        { type: 'jpeg', quality: 0.98 },
                    html2canvas:  { 
                        scale: 2, 
                        useCORS: true, 
                        logging: true,
                        scrollY: 0,
                        // æ±šæŸ“ã•ã‚ŒãŸç”»åƒãŒã‚ã£ã¦ã‚‚ç„¡è¦–ã—ã¦ç¶šè¡Œã™ã‚‹è¨­å®š
                        allowTaint: true 
                    },
                    jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' },
                    pagebreak:    { mode: ['avoid-all', 'css', 'legacy'] }
                };
                await html2pdf().set(opt).from(element).save();
            } else if (type === 'png') {
                const canvas = await html2canvas(element, {
                    scale: 2,
                    useCORS: true,
                    allowTaint: true,
                    scrollY: 0
                });
                
                const link = document.createElement('a');
                link.download = `ç‰©ç†ãƒ¬ãƒãƒ¼ãƒˆ_${new Date().toISOString().slice(0,10)}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
            }
        } catch (error) {
            console.error("Export Error:", error);
            alert('ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚\nç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚‰ãªã„ã€ã¾ãŸã¯ãƒ–ãƒ©ã‚¦ã‚¶ã®åˆ¶é™ã«ã‚ˆã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚\n\nè©³ç´°: ' + error.message);
        } finally {
            // å¾©å…ƒå‡¦ç†
            restoreInputs(replacements);
            restoreImages(); // ç”»åƒsrcã‚’æˆ»ã™
            noPrintElements.forEach(el => el.style.display = '');
            loading.style.display = 'none';
        }
    }
</script>

</body>
</html>
